<div class="room-container">
  <header class="room-header">
    <h1>Room: {{ roomId() }}</h1>
    <div class="connection-status">
      <span
        class="status-indicator"
        [class.connected]="socket.isConnected()"
        [attr.aria-label]="socket.isConnected() ? 'Connected' : 'Disconnected'"
      ></span>
      <span>{{ socket.isConnected() ? 'Connected' : 'Disconnected' }}</span>
    </div>
    <div class="room-timer" aria-label="Room duration">
      <span class="timer-icon">â±</span>
      <span>{{ formattedTime() }}</span>
    </div>
    <button
      type="button"
      class="btn btn-danger"
      (click)="leaveRoom()"
      aria-label="Leave room"
    >
      Leave Room
    </button>
  </header>

  <!-- Floating Reactions Container -->
  <div class="reactions-container" aria-live="polite" aria-label="Reactions">
    @for (reaction of floatingReactions(); track reaction.id) {
      <div 
        class="floating-reaction" 
        [style.left.%]="reaction.left"
      >
        <span class="reaction-emoji">{{ reaction.emoji }}</span>
        <span class="reaction-from">{{ reaction.fromName }}</span>
      </div>
    }
  </div>

  <main class="room-content">
    <section class="videos-section" [class.has-pinned]="pinnedVideo()" aria-label="Video streams">
      <!-- Pinned Video View -->
      @if (pinnedVideo()) {
        <div class="pinned-container">
          @if (pinnedVideo() === 'local' && webrtc.localStream()) {
            <div class="video-container pinned-video" [class.speaking]="webrtc.isLocalSpeaking()">
              <video
                autoplay
                muted
                playsinline
                aria-label="Your video (pinned)"
                [srcObject]="webrtc.localStream()"
              ></video>
              <span class="video-label">{{ socket.localDisplayName() }} (Camera) - Pinned</span>
              <button
                type="button"
                class="btn-unpin"
                (click)="unpinVideo()"
                aria-label="Unpin video"
              >
                ğŸ“Œ Unpin
              </button>
            </div>
          }
          @if (pinnedVideo() === 'local-screen' && webrtc.screenStream()) {
            <div class="video-container pinned-video screen-video">
              <video
                autoplay
                playsinline
                aria-label="Your screen share (pinned)"
                [srcObject]="webrtc.screenStream()"
              ></video>
              <span class="video-label">{{ socket.localDisplayName() }} (Screen) - Pinned</span>
              <button
                type="button"
                class="btn-unpin"
                (click)="unpinVideo()"
                aria-label="Unpin video"
              >
                ğŸ“Œ Unpin
              </button>
            </div>
          }
          @for (remote of webrtc.allRemoteStreams(); track remote.stream.id) {
            @if (pinnedVideo() === remote.peerId + '-' + remote.stream.id) {
              <div class="video-container pinned-video" [class.speaking]="webrtc.isPeerSpeaking(remote.peerId)">
                <video
                  autoplay
                  playsinline
                  [attr.aria-label]="'Video from ' + socket.getDisplayName(remote.peerId) + ' (pinned)'"
                  [srcObject]="remote.stream"
                ></video>
                <span class="video-label">{{ socket.getDisplayName(remote.peerId) }} - Pinned</span>
                <button
                  type="button"
                  class="btn-unpin"
                  (click)="unpinVideo()"
                  aria-label="Unpin video"
                >
                  ğŸ“Œ Unpin
                </button>
              </div>
            }
          }
        </div>
      }

      <!-- Thumbnails / Grid View -->
      <div class="videos-grid" [class.thumbnail-mode]="pinnedVideo()">
        @if (webrtc.localStream()) {
          <div 
            class="video-container local-video" 
            [class.speaking]="webrtc.isLocalSpeaking()"
            [class.is-pinned]="pinnedVideo() === 'local'"
          >
            <video
              autoplay
              muted
              playsinline
              aria-label="Your video"
              [srcObject]="webrtc.localStream()"
            ></video>
            <span class="video-label">{{ socket.localDisplayName() }} (Camera)</span>
            @if (webrtc.isLocalSpeaking()) {
              <span class="speaking-indicator" aria-label="Speaking"></span>
            }
            <button
              type="button"
              class="btn-pin"
              (click)="pinVideo('local')"
              [attr.aria-label]="pinnedVideo() === 'local' ? 'Unpin video' : 'Pin video'"
            >
              {{ pinnedVideo() === 'local' ? 'ğŸ“Œ' : 'ğŸ“' }}
            </button>
          </div>
        }

        @if (webrtc.screenStream()) {
          <div 
            class="video-container screen-video"
            [class.is-pinned]="pinnedVideo() === 'local-screen'"
          >
            <video
              autoplay
              playsinline
              aria-label="Your screen share"
              [srcObject]="webrtc.screenStream()"
            ></video>
            <span class="video-label">{{ socket.localDisplayName() }} (Screen)</span>
            <button
              type="button"
              class="btn-pin"
              (click)="pinVideo('local-screen')"
              [attr.aria-label]="pinnedVideo() === 'local-screen' ? 'Unpin video' : 'Pin video'"
            >
              {{ pinnedVideo() === 'local-screen' ? 'ğŸ“Œ' : 'ğŸ“' }}
            </button>
          </div>
        }

        @for (remote of webrtc.allRemoteStreams(); track remote.stream.id) {
          <div 
            class="video-container remote-video" 
            [class.speaking]="webrtc.isPeerSpeaking(remote.peerId)"
            [class.is-pinned]="pinnedVideo() === remote.peerId + '-' + remote.stream.id"
          >
            <video
              autoplay
              playsinline
              [attr.aria-label]="'Video from ' + socket.getDisplayName(remote.peerId)"
              [srcObject]="remote.stream"
              (loadedmetadata)="onRemoteVideoLoaded(remote.peerId, remote.stream)"
            ></video>
            <span class="video-label">{{ socket.getDisplayName(remote.peerId) }}</span>
            @if (webrtc.isPeerSpeaking(remote.peerId)) {
              <span class="speaking-indicator" aria-label="Speaking"></span>
            }
            <button
              type="button"
              class="btn-pin"
              (click)="pinVideo(remote.peerId + '-' + remote.stream.id)"
              [attr.aria-label]="pinnedVideo() === remote.peerId + '-' + remote.stream.id ? 'Unpin video' : 'Pin video'"
            >
              {{ pinnedVideo() === remote.peerId + '-' + remote.stream.id ? 'ğŸ“Œ' : 'ğŸ“' }}
            </button>
          </div>
        }
      </div>
    </section>

    @if (isChatVisible()) {
      <aside class="chat-section" aria-label="Chat">
        <div class="chat-header">
          <h2>Chat</h2>
          <button
            type="button"
            class="btn-close-chat"
            (click)="toggleChat()"
            aria-label="Hide chat"
          >
            âœ•
          </button>
        </div>
        <ul
          #chatBox
          class="chat-messages"
          role="log"
          aria-live="polite"
          aria-label="Chat messages"
        >
          @for (msg of messages(); track $index) {
            <li class="chat-message" [class.own-message]="msg.from === socket.socketId()">
              <strong>{{ msg.from === socket.socketId() ? socket.localDisplayName() : (msg.fromName || socket.getDisplayName(msg.from)) }}:</strong>
              {{ msg.message }}
            </li>
          }
        </ul>
        <form class="chat-input-form" (ngSubmit)="sendMessage()">
          <label for="chatInput" class="visually-hidden">Type a message</label>
          <input
            id="chatInput"
            type="text"
            [(ngModel)]="chatInput"
            name="chatInput"
            placeholder="Type a message..."
            autocomplete="off"
          />
          <button type="submit" class="btn btn-primary" aria-label="Send message">
            Send
          </button>
        </form>
      </aside>
    }
  </main>

  <footer class="room-controls">
    <button
      type="button"
      class="btn btn-control"
      [class.btn-off]="!webrtc.isVideoEnabled()"
      (click)="toggleVideo()"
      [attr.aria-pressed]="webrtc.isVideoEnabled()"
      aria-label="Toggle camera"
    >
      {{ webrtc.isVideoEnabled() ? 'ğŸ“¹ Camera On' : 'ğŸ“¹ Camera Off' }}
    </button>

    <button
      type="button"
      class="btn btn-control"
      [class.btn-off]="!webrtc.isAudioEnabled()"
      (click)="toggleAudio()"
      [attr.aria-pressed]="webrtc.isAudioEnabled()"
      aria-label="Toggle microphone"
    >
      {{ webrtc.isAudioEnabled() ? 'ğŸ¤ Mic On' : 'ğŸ¤ Mic Off' }}
    </button>

    <button
      type="button"
      class="btn btn-control"
      [class.btn-off]="!isSpeakerEnabled()"
      (click)="toggleSpeaker()"
      [attr.aria-pressed]="isSpeakerEnabled()"
      aria-label="Toggle speaker"
    >
      {{ isSpeakerEnabled() ? 'ğŸ”Š Speaker On' : 'ğŸ”‡ Speaker Off' }}
    </button>

    <button
      type="button"
      class="btn btn-screen-share"
      [class.btn-active]="webrtc.isScreenSharing()"
      (click)="toggleScreenShare()"
      [attr.aria-pressed]="webrtc.isScreenSharing()"
      aria-label="Toggle screen sharing"
    >
      {{ webrtc.isScreenSharing() ? 'ğŸ›‘ Stop Sharing' : 'ğŸ–¥ï¸ Share Screen' }}
    </button>

    <div class="reactions-picker-wrapper">
      <button
        type="button"
        class="btn btn-reactions"
        [class.btn-active]="showReactionsPicker()"
        (click)="toggleReactionsPicker()"
        aria-label="Open reactions"
        aria-haspopup="true"
        [attr.aria-expanded]="showReactionsPicker()"
      >
        ğŸ˜€ React
      </button>
      @if (showReactionsPicker()) {
        <div class="reactions-picker" role="menu" aria-label="Choose a reaction">
          @for (emoji of availableReactions; track emoji) {
            <button
              type="button"
              class="reaction-btn"
              (click)="sendReaction(emoji)"
              [attr.aria-label]="'Send ' + emoji + ' reaction'"
              role="menuitem"
            >
              {{ emoji }}
            </button>
          }
        </div>
      }
    </div>

    <button
      type="button"
      class="btn btn-settings"
      (click)="toggleSettings()"
      [class.btn-active]="showSettings()"
      aria-label="Settings"
    >
      âš™ï¸ Settings
    </button>

    <button
      type="button"
      class="btn btn-chat"
      [class.btn-active]="isChatVisible()"
      (click)="toggleChat()"
      [attr.aria-pressed]="isChatVisible()"
      aria-label="Toggle chat"
    >
      {{ isChatVisible() ? 'ğŸ’¬ Hide Chat' : 'ğŸ’¬ Show Chat' }}
    </button>
  </footer>

  @if (showSettings()) {
    <div class="settings-panel" role="dialog" aria-label="Device settings">
      <div class="settings-header">
        <h3>Device Settings</h3>
        <button
          type="button"
          class="btn-close"
          (click)="toggleSettings()"
          aria-label="Close settings"
        >
          âœ•
        </button>
      </div>
      <div class="settings-content">
        <div class="setting-group">
          <label for="videoInput">Camera</label>
          <select
            id="videoInput"
            [(ngModel)]="selectedVideoDevice"
            (change)="onVideoDeviceChange()"
          >
            @for (device of videoDevices(); track device.deviceId) {
              <option [value]="device.deviceId">{{ device.label }}</option>
            }
          </select>
        </div>

        <div class="setting-group">
          <label for="audioInput">Microphone</label>
          <select
            id="audioInput"
            [(ngModel)]="selectedAudioInput"
            (change)="onAudioInputChange()"
          >
            @for (device of audioInputDevices(); track device.deviceId) {
              <option [value]="device.deviceId">{{ device.label }}</option>
            }
          </select>
        </div>

        <div class="setting-group">
          <label for="audioOutput">Speaker</label>
          <select
            id="audioOutput"
            [(ngModel)]="selectedAudioOutput"
            (change)="onAudioOutputChange()"
          >
            @for (device of audioOutputDevices(); track device.deviceId) {
              <option [value]="device.deviceId">{{ device.label }}</option>
            }
          </select>
        </div>
      </div>
    </div>
  }
</div>
